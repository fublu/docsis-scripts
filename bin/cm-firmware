#!/usr/bin/env bash

CM_SNMP_COMMUNITY=private
CM_SNMP_TIMEOUT=6
CM_SNMP_RETRIES=2

usage()
{
cat << EOF
usage: $0 options

This script gets Cable Modem Firmware Information.
More scripts at https://github.com/martinclaro/docsis-scripts/

OPTIONS:
    -h          Show this message
    -i ipaddr   CM IP address
    -c text     CM SNMP Community (default: ${CM_SNMP_COMMUNITY})

EOF
}

while getopts “hi:c:” OPTION
do
    case $OPTION in
        h)
            usage
            exit 1
            ;;
        i)
            CM_IPADDR=$OPTARG
            ;;
        c)
            CM_SNMP_COMMUNITY=$OPTARG
            ;;
        ?)
            usage
            exit 1
            ;;
    esac
done

if [ "no${CM_IPADDR}" == "no" ]; then
    usage
    exit 1
fi

SNMP_OID_SW_ADMIN_STATUS=".1.3.6.1.2.1.69.1.3.3.0"      # DOCS-CABLE-DEVICE-MIB::docsDevSwAdminStatus.0
SNMP_OID_SW_OPER_STATUS=".1.3.6.1.2.1.69.1.3.4.0"       # DOCS-CABLE-DEVICE-MIB::docsDevSwOperStatus.0
SNMP_OID_IFTYPE=".1.3.6.1.2.1.2.2.1.3"                  # RFC1213-MIB::ifType
SNMP_OID_PHYADDR_BASE=".1.3.6.1.2.1.2.2.1.6"            # RFC1213-MIB::ifPhysAddress

# MAC address
CM_IFINDEX=`snmpbulkwalk -v 2c -c "$CM_SNMP_COMMUNITY" -m all -t $CM_SNMP_TIMEOUT -r $CM_SNMP_RETRIES -OnU -Ih -m all ${CM_IPADDR} ${SNMP_OID_IFTYPE} | grep ' 127$' | awk '{print $1}' | sed -e 's,^[0-9\.]*\([0-9]\),\1,g'`
CM_MAC=`snmpget -v 2c -c "${CM_SNMP_COMMUNITY}" -Ih -Onvq -m all -t $CM_SNMP_TIMEOUT -r $CM_SNMP_RETRIES ${CM_IPADDR} ${SNMP_OID_PHYADDR_BASE}.${CM_IFINDEX} | tr '[:upper:]' '[:lower:]' | sed -e 's,[^a-f0-9],,g'`

# Get Vendor / Model / Firmware from CM
CM_BULK=`snmpbulkget -v 2c -c "$CM_SNMP_COMMUNITY" -m all -t $CM_SNMP_TIMEOUT -r $CM_SNMP_RETRIES -Cr1 -Cn0 -On $CM_IPADDR .1.3.6.1.2.1.1.1 2>&1`
CM_SYSDESCR=`echo "${CM_BULK}" | grep '.1.3.6.1.2.1.1.1.0' | grep '<<'`
CM_HWREV=`echo "${CM_SYSDESCR}" | sed -e 's,.*<<\(.*\)>>.*,\1,g' | sed -e 's,^.*[Hh][Ww]_[Rr][Ee][Vv]:,,g' | sed -e 's,;.*$,,g' | sed -e 's,^ ,,g' | sed -e 's, $,,g'`
CM_VENDOR=`echo "${CM_SYSDESCR}" | sed -e 's,.*<<\(.*\)>>.*,\1,g' | sed -e 's,^.*[Vv][Ev][Nn][Dd][Oo][Rr]:,,g' | sed -e 's,;.*$,,g' | sed -e 's,^ ,,g' | sed -e 's, $,,g'`
CM_ROM=`echo "${CM_SYSDESCR}" | sed -e 's,.*<<\(.*\)>>.*,\1,g' | sed -e 's,^.*[Bb][Oo][Oo][Tt][Rr]:,,g' | sed -e 's,;.*$,,g' | sed -e 's,^ ,,g' | sed -e 's, $,,g'`
CM_FIRM=`echo "${CM_SYSDESCR}" | sed -e 's,.*<<\(.*\)>>.*,\1,g' | sed -e 's,^.*[Ss][Ww]_[Rr][Ee][Vv]:,,g' | sed -e 's,;.*$,,g' | sed -e 's,^ ,,g' | sed -e 's, $,,g'`
CM_MODEL=`echo "${CM_SYSDESCR}" | sed -e 's,.*<<\(.*\)>>.*,\1,g' | sed -e 's,^.*[Mm][Oo][Dd][Ee][Ll]:,,g' | sed -e 's,;.*$,,g' | sed -e 's,^ ,,g' | sed -e 's, $,,g'`

# Status
SW_ADMIN_STATUS=`snmpget -v 2c -c "${CM_SNMP_COMMUNITY}" -Ih -Onvq -m all -t $CM_SNMP_TIMEOUT -r $CM_SNMP_RETRIES ${CM_IPADDR} ${SNMP_OID_SW_ADMIN_STATUS}`
SW_OPER_STATUS=`snmpget -v 2c -c "${CM_SNMP_COMMUNITY}" -Ih -Onvq -m all -t $CM_SNMP_TIMEOUT -r $CM_SNMP_RETRIES ${CM_IPADDR} ${SNMP_OID_SW_OPER_STATUS}`

cat << EOF

### Cable Modem ${CM_MAC:0:4}.${CM_MAC:4:4}.${CM_MAC:8:4} Firmware ###

Cable Modem IP address: ${CM_IPADDR}

Vendor:                 ${CM_VENDOR:-N/A}
Model:                  ${CM_MODEL:-N/A}
Hardware Version:       ${CM_HWREV:-N/A}
Software Version:       ${CM_FIRM:-N/A}
Boot ROM Version:       ${CM_ROM:-N/A}

Admin Status:           ${SW_ADMIN_STATUS:-N/A}
Operational Status:     ${SW_OPER_STATUS:-N/A}

EOF

exit 0